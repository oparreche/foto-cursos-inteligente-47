
import { supabase } from '@/integrations/supabase/client';

// Define simple response types outside of functions to avoid recreation
interface ProfileResponse {
  data: { id: string } | null;
  error: any;
}

interface InsertResponse {
  data: any;
  error: any;
}

export async function findUserByEmail(email: string): Promise<string | undefined> {
  try {
    // Use two-step type assertion to bypass deep type inference
    // First cast to unknown, then to our simple interface
    const response = (await supabase
      .from('profiles')
      .select('id')
      .eq('email', email)
      .limit(1)
      .single() as unknown) as ProfileResponse;
      
    if (response.error) throw response.error;
    return response.data?.id;
  } catch (error) {
    console.error('Error finding user by email:', error);
    return undefined;
  }
}

export async function createUser(
  email: string,
  firstName: string,
  lastName: string,
  profileData: {
    cpf?: string;
    birthDate?: string;
    phone?: string;
    address?: string;
    addressNumber?: string;
    addressComplement?: string;
    neighborhood?: string;
    city?: string;
    state?: string;
    postalCode?: string;
  }
): Promise<string | undefined> {
  try {
    // First check if user already exists
    const existingUserId = await findUserByEmail(email);
    if (existingUserId) return existingUserId;
    
    // Create profile entry with UUID generated by Supabase
    const profileId = crypto.randomUUID();
    
    // Use two-step type assertion to bypass deep type inference
    // First cast to unknown, then to our simple interface
    const response = (await supabase
      .from('profiles')
      .insert({
        id: profileId,
        email: email,
        first_name: firstName,
        last_name: lastName,
        cpf: profileData.cpf,
        birth_date: profileData.birthDate,
        phone: profileData.phone,
        address: profileData.address,
        address_number: profileData.addressNumber,
        address_complement: profileData.addressComplement,
        neighborhood: profileData.neighborhood,
        city: profileData.city,
        state: profileData.state,
        postal_code: profileData.postalCode
      }) as unknown) as InsertResponse;
    
    if (response.error) throw response.error;
    return profileId;
  } catch (error) {
    console.error('Error creating user:', error);
    return undefined;
  }
}
